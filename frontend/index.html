<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script>
        // Simple upload extension for htmx - just ensures Authorization header is set
        htmx.defineExtension('upload', {
            onEvent: function(name, evt) {
                if (name === "htmx:beforeRequest") {
                    var form = evt.detail.elt;
                    if (form.tagName === "FORM" && form.hasAttribute("hx-ext")) {
                        console.log("Upload extension active for form:", form.id);
                        
                        // Initialize headers if undefined
                        if (!evt.detail.headers) {
                            evt.detail.headers = {};
                        }
                        
                        // Set Authorization header if token is available
                        if (typeof accessToken !== 'undefined' && accessToken) {
                            evt.detail.headers['Authorization'] = 'Bearer ' + accessToken;
                            console.log("✅ Authorization header set in HTMX extension:", 'Bearer ' + accessToken.substring(0, 20) + '...');
                        } else {
                            console.log("❌ No access token available for upload");
                        }
                    }
                }
            }
        });
    </script>
    <script src="config.js"></script>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #11182d;
            --panel-border: #1f2b48;
            --text: #e6ecff;
            --muted: #9fb0d3;
            --primary: #4f7cff;
            --primary-600: #3c63d6;
            --success-bg: #0f3322;
            --success-border: #1e7a53;
            --error-bg: #331616;
            --error-border: #7a2a2a;
            --radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
        }

        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 10% -10%, #1a2a6c33, transparent 60%),
                radial-gradient(900px 500px at 110% 10%, #b21f1f22, transparent 50%),
                linear-gradient(180deg, #0a0f1e 0%, #090d1a 100%);
            overflow-x: hidden;
        }

        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }

        /* Top header (logout on the right) */
        .app-header { position: fixed; top: 14px; right: 18px; z-index: 20; }

        .app-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.3px;
            margin: 8px 0 24px;
            background: linear-gradient(90deg, #a0b4ff, #e6ecff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: var(--radius);
            padding: 28px 24px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(6px);
            margin: 18px 0;
        }

        .card h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            margin: 0 0 10px;
        }
        .card h2 .step {
            display: inline-grid;
            place-items: center;
            width: 26px;
            height: 26px;
            border-radius: 8px;
            background: #1b2550;
            border: 1px solid #2a3770;
            color: #cfe0ff;
            font-size: 13px;
            font-weight: 700;
        }

        .muted { color: var(--muted); }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
            box-shadow: 0 6px 18px rgba(79,124,255,.25);
        }
        .btn:active { transform: translateY(1px) scale(.99); }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-600); }
        .btn-secondary { background: #233158; box-shadow: 0 6px 18px rgba(35,49,88,.25); }

        input[type="file"] {
            width: 100%;
            color: var(--muted);
            background: #0e1530;
            border: 1px dashed #2b3a6a;
            border-radius: 10px;
            padding: 22px;
            margin: 14px 0 18px;
            font-size: 15px;
        }

        .progress {
            margin-top: 8px;
        }
        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #0e1530;
            border: 1px solid #213264;
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4f7cff, #8aa4ff);
            transition: width 0.25s ease-in-out;
        }
        .progress-text { color: var(--muted); font-size: 12px; margin: 8px 0 6px; }

        .status {
            padding: 12px 14px;
            margin: 12px 0;
            border-radius: 10px;
            border: 1px solid transparent;
        }
        .status.success { background: var(--success-bg); border-color: var(--success-border); }
        .status.error { background: var(--error-bg); border-color: var(--error-border); }

        .footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 22px; }

        /* Center stage for login */
        .center-stage { min-height: 70vh; display: grid; place-items: center; }

        /* Floating subtle bubbles */
        .bubbles { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
        .bubbles span { position: absolute; display: block; width: var(--s,14px); height: var(--s,14px); border-radius: 999px; background: radial-gradient(#a0b4ff22,#a0b4ff00 70%); filter: blur(2px); animation: drift var(--t,18s) linear infinite; }
        @keyframes drift { 0% { transform: translate(var(--x,0), var(--y,0)) scale(1); opacity:.25; } 50% { transform: translate(calc(var(--x,0) * -1), calc(var(--y,0) * -1)) scale(1.12); opacity:.18; } 100% { transform: translate(var(--x,0), var(--y,0)) scale(1); opacity:.25; } }
    </style>
</head>
<body>
    <!-- floating bubbles background -->
    <div class="bubbles" aria-hidden="true">
      <span style="left:6%; top:12%; --x:80px; --y:-120px; --s:18px; --t:19s"></span>
      <span style="left:22%; top:76%; --x:-140px; --y:-60px; --s:12px; --t:23s"></span>
      <span style="left:38%; top:28%; --x:120px; --y:80px; --s:22px; --t:21s"></span>
      <span style="left:52%; top:64%; --x:-90px; --y:120px; --s:16px; --t:20s"></span>
      <span style="left:71%; top:18%; --x:-130px; --y:90px; --s:14px; --t:26s"></span>
      <span style="left:84%; top:52%; --x:110px; --y:-110px; --s:20px; --t:24s"></span>
      <span style="left:12%; top:44%; --x:140px; --y:140px; --s:10px; --t:28s"></span>
      <span style="left:64%; top:82%; --x:-120px; --y:-80px; --s:16px; --t:22s"></span>
      <span style="left:46%; top:8%; --x:100px; --y:140px; --s:12px; --t:27s"></span>
      <span style="left:90%; top:30%; --x:-160px; --y:60px; --s:18px; --t:25s"></span>
    </div>

    <div class="container">
      <div class="app-title" style="text-align:left;">Secure File Upload System</div>

      <!-- LOGIN PAGE (index) -->
      <div id="login-card" class="auth-section card center-stage">
        <h2><span class="step">1</span> Login</h2>
        <p class="muted">Authenticate with Keycloak to continue to the upload page.</p>
        <button class="btn btn-primary" style="justify-self:center; min-width: 220px; font-size: 16px" onclick="authenticateUser()">Login with Keycloak</button>
        <div id="auth-status"></div>
    </div>

      <div class="footer">Built with Rust, Actix, Keycloak, HTMX</div>
    </div>

    <script>
        console.log('JavaScript is loading (login page)...');
        let accessToken = null;
        let codeVerifier = null;

        // Generate PKCE code verifier and challenge
        function generatePKCE() {
            // Generate code verifier (random string)
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            codeVerifier = btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
            
            // Generate code challenge (SHA256 hash of verifier)
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
                .then(hash => {
                    const codeChallenge = btoa(String.fromCharCode.apply(null, new Uint8Array(hash)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                    return codeChallenge;
                });
        }

        // Authentication function with PKCE
        async function authenticateUser() {
            try {
                // Generate PKCE parameters
                const codeChallenge = await generatePKCE();
                
                // Store code verifier for later use
                sessionStorage.setItem('code_verifier', codeVerifier);
                
                // Build authorization URL with PKCE
                const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
                const state = Math.random().toString(36).substring(2, 15);
                
                const authUrl = `${CONFIG.getKeycloakAuthUrl()}?` +
                    `client_id=${CONFIG.CLIENT_ID}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=openid&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256&` +
                    `state=${state}`;
                
                // Store state for validation
                sessionStorage.setItem('oauth_state', state);
                
                // Redirect to Keycloak
                window.location.href = authUrl;
                
            } catch (error) {
                document.getElementById('auth-status').innerHTML = 
                    '<div class="status error">Authentication failed: ' + error.message + '</div>';
            }
        }

        // Handle OAuth2 callback after redirect from Keycloak
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            if (error) {
                document.getElementById('auth-status').innerHTML = 
                    `<div class="status error">Authentication failed: ${error}</div>`;
                return;
            }
            
            if (code && state) {
                // Validate state
                const storedState = sessionStorage.getItem('oauth_state');
                if (state !== storedState) {
                    document.getElementById('auth-status').innerHTML = 
                        '<div class="status error">Invalid state parameter</div>';
                    return;
                }
                
                // Exchange code for token
                await exchangeCodeForToken(code);
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function exchangeCodeForToken(code) {
            try {
                // First check if upload service is healthy
                const healthResponse = await fetch(CONFIG.getHealthUrl());
                if (!healthResponse.ok) {
                    throw new Error('Upload service is not available');
                }
                
                // Retrieve stored code verifier
                const storedCodeVerifier = sessionStorage.getItem('code_verifier');
                if (!storedCodeVerifier) {
                    throw new Error('Code verifier not found in session storage');
                }
                
                // Use backend token exchange endpoint instead of calling Keycloak directly
                const response = await fetch(`${CONFIG.BACKEND_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        code_verifier: storedCodeVerifier,
                        redirect_uri: window.location.origin + window.location.pathname
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    
                    // Persist token for the upload page and redirect
                    sessionStorage.setItem('access_token', accessToken);
                    window.location.href = 'upload.html';
                } else {
                    throw new Error('Failed to get access token');
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML = 
                    '<div class="status error">Authentication failed: ' + error.message + '</div>';
            }
        }
        // Logout not used on login page

        // Initialize page - check for OAuth callback
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Check if we're returning from OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            console.log('URL params:', urlParams.toString());
            if (urlParams.has('code') || urlParams.has('error')) {
                console.log('OAuth callback detected');
                handleOAuthCallback();
            } else {
                console.log('Normal page load, showing login');
                document.getElementById('login-card').style.display = 'grid';
            }
        });
    </script>
</body>
</html>