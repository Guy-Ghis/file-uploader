<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script>
        htmx.defineExtension('upload', {
            onEvent: function(name, evt) {
                if (name === "htmx:beforeRequest") {
                    var form = evt.detail.elt;
                    if (form.tagName === "FORM" && form.hasAttribute("hx-ext")) {
                        if (!evt.detail.headers) evt.detail.headers = {};
                        if (typeof accessToken !== 'undefined' && accessToken) {
                            evt.detail.headers['Authorization'] = 'Bearer ' + accessToken;
                        }
                    }
                }
            }
        });
    </script>
    <script src="config.js"></script>
    <style>
        :root {
            --bg-start:#0f1724; --bg-end:#0b1220;
            --panel:#151c2c; --panel-border:#1f2a40; --text:#e8eefc; --muted:#a7b6d6;
            --primary:#ff8a33; --primary-600:#e67622; --radius:14px; --shadow:0 12px 36px rgba(0,0,0,.35);
        }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 15% -10%, #2a3c6433, transparent 60%),
                radial-gradient(900px 500px at 110% 10%, #1c2a4f22, transparent 50%),
                linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);
            overflow-x: hidden;
        }
        .titlebar{position:fixed;top:0;left:0;right:0;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:linear-gradient(180deg, #0e1526aa, #0e152688);backdrop-filter:blur(8px);border-bottom:1px solid #1c2640;z-index:50}
        .titlebar-left{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px}
        .window-controls{display:flex;align-items:center;gap:8px}
        .window-dot{width:10px;height:10px;border-radius:999px;background:#3a4a6d;border:1px solid #4b5e8d}

        .container { max-width: 980px; margin: 0 auto; padding: 72px 24px 80px; }
        .center-stage { min-height: 70vh; display: grid; place-items: center; }
        .card { background: var(--panel); border: 1px solid var(--panel-border); border-radius: var(--radius); padding: 28px 24px; box-shadow: var(--shadow); backdrop-filter: blur(6px); margin: 18px 0; }
        .muted { color: var(--muted); }
        .btn { appearance: none; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 700; color: #0a0f1e; cursor: pointer; transition: transform .06s ease, background .2s ease, box-shadow .2s ease; box-shadow: 0 8px 20px rgba(255,138,51,.25); }
        .btn:active { transform: translateY(1px) scale(.99); }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-600); }
        .footer { color: var(--muted); font-size: 12px; text-align: center; margin-top: 22px; }

        .bubbles { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
        .bubbles span { position: absolute; display: block; width: var(--s,14px); height: var(--s,14px); border-radius: 999px; background: radial-gradient(#a0b4ff22,#a0b4ff00 70%); filter: blur(2px); animation: drift var(--t,18s) linear infinite; }
        @keyframes drift { 0% { transform: translate(var(--x,0), var(--y,0)) scale(1); opacity:.25; } 50% { transform: translate(calc(var(--x,0) * -1), calc(var(--y,0) * -1)) scale(1.12); opacity:.18; } 100% { transform: translate(var(--x,0), var(--y,0)) scale(1); opacity:.25; } }
    </style>
</head>
<body>
    <div class="titlebar">
      <div class="titlebar-left">
        <div class="window-controls">
          <span class="window-dot"></span>
          <span class="window-dot"></span>
          <span class="window-dot"></span>
        </div>
        <div style="margin-left:10px">FileStack</div>
      </div>
      <div></div>
    </div>

    <!-- floating bubbles background -->
    <div class="bubbles" aria-hidden="true">
      <span style="left:6%; top:12%; --x:80px; --y:-120px; --s:18px; --t:19s"></span>
      <span style="left:22%; top:76%; --x:-140px; --y:-60px; --s:12px; --t:23s"></span>
      <span style="left:38%; top:28%; --x:120px; --y:80px; --s:22px; --t:21s"></span>
      <span style="left:52%; top:64%; --x:-90px; --y:120px; --s:16px; --t:20s"></span>
      <span style="left:71%; top:18%; --x:-130px; --y:90px; --s:14px; --t:26s"></span>
      <span style="left:84%; top:52%; --x:110px; --y:-110px; --s:20px; --t:24s"></span>
    </div>

    <div class="container">
      <div class="app-title" style="text-align:left; display:none;">Secure File Upload System</div>

      <!-- LOGIN PAGE (index) -->
      <div id="login-card" class="auth-section card center-stage">
        <div style="font-size:26px;font-weight:700;margin-bottom:10px">Welcome to FileStack</div>
        <p class="muted">Authenticate with Keycloak to continue to the upload page.</p>
        <button class="btn btn-primary" style="justify-self:center; min-width: 240px; font-size: 16px" onclick="authenticateUser()">Login with Keycloak</button>
        <div id="auth-status" style="margin-top:12px"></div>
      </div>

      <div class="footer">Built with Rust, Actix, Keycloak, HTMX</div>
    </div>

    <script>
        console.log('JavaScript is loading (login page)...');
        let accessToken = null;
        let codeVerifier = null;
        function generatePKCE() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            codeVerifier = btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
                .then(hash => {
                    const codeChallenge = btoa(String.fromCharCode.apply(null, new Uint8Array(hash)))
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_')
                        .replace(/=/g, '');
                    return codeChallenge;
                });
        }
        async function authenticateUser() {
            try {
                const codeChallenge = await generatePKCE();
                sessionStorage.setItem('code_verifier', codeVerifier);
                const redirectUri = encodeURIComponent(window.location.origin + window.location.pathname);
                const state = Math.random().toString(36).substring(2, 15);
                const authUrl = `${CONFIG.getKeycloakAuthUrl()}?` +
                    `client_id=${CONFIG.CLIENT_ID}&` +
                    `redirect_uri=${redirectUri}&` +
                    `response_type=code&` +
                    `scope=openid&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256&` +
                    `state=${state}`;
                sessionStorage.setItem('oauth_state', state);
                window.location.href = authUrl;
            } catch (error) {
                document.getElementById('auth-status').innerHTML = 
                    '<div class="status error">Authentication failed: ' + error.message + '</div>';
            }
        }
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            if (error) {
                document.getElementById('auth-status').innerHTML = 
                    `<div class="status error">Authentication failed: ${error}</div>`;
                return;
            }
            if (code && state) {
                const storedState = sessionStorage.getItem('oauth_state');
                if (state !== storedState) {
                    document.getElementById('auth-status').innerHTML = 
                        '<div class="status error">Invalid state parameter</div>';
                    return;
                }
                await exchangeCodeForToken(code);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        async function exchangeCodeForToken(code) {
            try {
                const healthResponse = await fetch(CONFIG.getHealthUrl());
                if (!healthResponse.ok) throw new Error('Upload service is not available');
                const storedCodeVerifier = sessionStorage.getItem('code_verifier');
                if (!storedCodeVerifier) throw new Error('Code verifier not found in session storage');
                const response = await fetch(`${CONFIG.BACKEND_URL}/token`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, code_verifier: storedCodeVerifier, redirect_uri: window.location.origin + window.location.pathname })
                });
                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    sessionStorage.setItem('access_token', accessToken);
                    if (data.refresh_token) sessionStorage.setItem('refresh_token', data.refresh_token);
                    window.location.href = 'upload.html';
                } else {
                    throw new Error('Failed to get access token');
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML = 
                    '<div class="status error">Authentication failed: ' + error.message + '</div>';
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code') || urlParams.has('error')) {
                handleOAuthCallback();
            } else {
                document.getElementById('login-card').style.display = 'grid';
            }
        });
    </script>
</body>
</html>